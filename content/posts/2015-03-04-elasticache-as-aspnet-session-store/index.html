---
layout: post
title: ElastiCache as an ASP.NET Session Store
date: '2015-03-04T14:52:00.000-05:00'
author: Brian
tags: 
modified_time: '2015-10-24T15:11:19.589-04:00'
blogger_id: tag:blogger.com,1999:blog-5050074367798755574.post-1957929008056864833
blogger_orig_url: http://blog.brianbeach.com/2015/03/elasticache-as-aspnet-session-store.html
---

<p style="text-align: center;color: red;">NOTE: This article is reposted from the AWS .Net Blog. &nbsp;Please post comments <a href="https://blogs.aws.amazon.com/net/post/TxMREMF0459SXT/-span-class-matches-ElastiCache-span-as-an-ASP-NET-Session-Store">here</a>.</p>

<p>
 Are you hosting an ASP.NET application on AWS? Do you want the benefits of <a href="http://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancing (ELB)</a> and <a href="http://aws.amazon.com/autoscaling/">Auto Scaling</a>, but feel limited by a dependency on ASP.NET session state? Rather than rely on sticky sessions, you can use an out-of-process session state provider to share session state between multiple web servers. In this post, I will show you how to configure ElastiCache and the RedisSessionStateProvider from Microsoft to eliminate the dependency on sticky sessions.</p>
<h2>
 Background</h2>
<p>
 An <a href="https://msdn.microsoft.com/en-us/library/aa478952.aspx">ASP.NET session state provider</a> maintains a user’s session between requests to an ASP.NET application. For example, you might store the contents of a shopping cart in session state. The default provider stores the user’s session in memory on the web server that received the request.</p>
<p>
 Using the default provider, your ELB must send every request from a specific user to the same web server. This is known as <a href="http://docs.aws.amazon.com/ElasticLoadBalancing/latest/DeveloperGuide/US_StickySessions.html">sticky sessions</a> and greatly limits your elasticity. First, the ELB cannot distribute traffic evenly, often sending a disproportionate amount of traffic to one server. Second, Auto Scaling cannot terminate web servers without losing some user’s session state.</p>
<p>
 By moving the session state to a central location, all the web servers can share a single copy of session state. This allows the ELB to send requests to any web server, better distributing load across all the web servers. In addition, Auto Scaling can terminate individual web servers without losing session state information.</p>
<p>
 There are numerous providers available that allow multiple web servers to share session state. One option is use the <a href="http://docs.aws.amazon.com/AWSSdkDocsNET/latest/DeveloperGuide/net-dg-dynamodb-session.html">DynamoDB Session State Provider</a> that ships with the <a href="http://aws.amazon.com/sdk-for-net/">AWS SDK for .NET.</a> This post introduces another option, storing session state in an ElastiCache cluster.</p>
<p>
 <a href="http://aws.amazon.com/elasticache/">ElastiCache</a> is a web service that makes it easy to deploy, operate, and scale an in-memory cache in the cloud. ElastiCache supports both Memcached and Redis cache clusters. While either technology can store ASP.NET session state, Microsoft offers a <a href="http://blogs.msdn.com/b/webdev/archive/2014/05/12/announcing-asp-net-session-state-provider-for-redis-preview-release.aspx">provider for Redis</a>, and I will focus on Redis here.</p>
<h2>
 Launch an Elasticache for Redis Cluster</h2>
<p>
 Let us begin by launching a new Elasticache for Redis cluster in the <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html">default VPC</a> using PowerShell. Note that you can use the <a href="https://console.aws.amazon.com/elasticache/home">ElastiCache console</a> if you prefer.</p>
<p>
 First, get a reference to the default VPC and create a new security group for the cluster. The security group must allow inbound requests to Redis, which uses TCP port 6379.</p>
<pre class="brush: powershell;">
$VPC = Get-EC2Vpc -Filter @{name='isDefault'; value='true'}
$Group = New-EC2SecurityGroup -GroupName 'ElastiCacheRedis' -Description 'Allows TCP Port 6379'
Grant-EC2SecurityGroupIngress -GroupId $Group -IpPermission  @{ IpProtocol=&quot;tcp&quot;; FromPort=&quot;6379&quot;; ToPort=&quot;6379&quot;; IpRanges=$VPC.CidrBlock }</pre>
<p>
 Second, launch a new Redis cluster. In the example below, I launch a single node cluster named “aspnet” running on a t2.micro. Make sure you specify the security group you created above.</p>
<pre class="brush: powershell;">
New-ECCacheCluster -CacheClusterId 'aspnet' -Engine 'redis' -CacheNodeType 'cache.t2.micro' -NumCacheNode 1 -SecurityGroupId $Group</pre>
<p>
 Finally, get the endpoint address of the instance you just created. Note that you must wait a few minutes for the cluster to launch before the address is available.</p>
<pre class="brush: powershell;">
(Get-ECCacheCluster -CacheClusterId 'aspnet' -ShowCacheNodeInfo $true).CacheNodes[0].Endpoint.Address</pre>
<p>
 The endpoint address is a fully qualified domain name that ends in cache.amazon.com and resolves to a private IP address in the VPC. For example, ElastiCache assigned my cluster the address below.</p>
<pre>
aspnet.k30h8n.0001.use1.cache.amazonaws.com</pre>
<h2>
 Configuring the Redis Session State Provider</h2>
<p>
 With the Redis cluster running, you are ready to add the RedisSessionStateProvider to your ASP.NET application. Open your project in Visual Studio. First, right click on the project in Solution Explorer and select Manage NuGet Packages. Then, search for “RedisSessionStateProvider” and click the Install button as show below.</p>
<p>
 <img alt="Manage NuGet Packages" src="http://cdn.amazonblogs.com/net_awsblog/images/ElastiCacheSessionStateFigure1.png" style="width: 550px; height: 367px;" /></p>
<p>
 NuGet will add a custom session state provider to your project’s web.config file. Open the web.config file and locate the Microsoft.Web.Redis.RedisSessionStateProvider shown below.</p>
<pre class="brush: text;">
&lt;sessionState mode=&quot;Custom&quot; customProvider=&quot;MySessionStateStore&quot;&gt;
&nbsp; &lt;providers&gt;
&nbsp;&nbsp;&nbsp; &lt;add name=&quot;MySessionStateStore&quot; type=&quot;Microsoft.Web.Redis.RedisSessionStateProvider&quot; host=&quot;127.0.0.1&quot; accessKey=&quot;&quot; ssl=&quot;false&quot; /&gt;
&nbsp; &lt;/providers&gt;
&lt;/sessionState&gt;
</pre>
<p>
 Now replace the host attribute with the endpoint address you received from Get-ECCacheCluster. For example, my configuration looks like this.</p>
<pre class="brush: text;">
&lt;sessionState mode=&quot;Custom&quot; customProvider=&quot;MySessionStateStore&quot;&gt;
&nbsp; &lt;providers&gt;
&nbsp;&nbsp;&nbsp; &lt;add name=&quot;MySessionStateStore&quot; type=&quot;Microsoft.Web.Redis.RedisSessionStateProvider&quot; host=&quot;aspnet.k30h8n.0001.use1.cache.amazonaws.com&quot; accessKey=&quot;&quot; ssl=&quot;false&quot; /&gt;
&nbsp; &lt;/providers&gt;
&lt;/sessionState&gt;
</pre>
<p>
 You are now ready to deploy and test your application. Wasn’t that easy?</p>
<h2>
 Summary</h2>
<p>
 You can use ElastiCache to share ASP.NET session information with multiple web servers and eliminate the dependency on ELB stick sessions. ElastiCache is simple to use and integrates with ASP.NET using the RedisSessionStateProvider available as a NuGet package. For more information about ElastiCache, see the <a href="http://aws.amazon.com/documentation/elasticache/">ElastiCache documentation</a>.</p>